<?php declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use MageOS\ThemeOptimization\ViewModel\BfCache;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */
/** @var BfCache $bfcacheConfig */
$bfcacheConfig = $viewModels->require(BfCache::class);
?>

<script>
    (() => {
        class BFCacheHandler {
            constructor() {
                this.options = {
                    isCustomerLoggedIn: <?= json_encode($bfcacheConfig->isCustomerLoggedIn()) ?>,
                    enableUserInteractionRefreshMiniCart: <?= json_encode($bfcacheConfig->isReloadMiniCartOnInteraction()) ?>,
                    autoCloseMenuMobile: <?= json_encode($bfcacheConfig->autoCloseMenuMobile()) ?>
                };

                this.userInteractionEvents = ['touchstart', 'mouseover', 'wheel', 'keydown'];
            }

            init() {
                this.refreshMiniCart();
                this.reloadCustomerLoginPage();
                this.actionAutoCloseMenu(this.options.autoCloseMenuMobile);
            }

            refreshMiniCart() {
                if (this.options.enableUserInteractionRefreshMiniCart) {
                    this.refreshMiniCartOnUserInteraction();
                } else {
                    this.actionRefreshMiniCart();
                }
            }

            refreshMiniCartOnUserInteraction() {
                const refreshMiniCart = () => {
                    this.userInteractionEvents.forEach(eventType => {
                        window.removeEventListener(eventType, refreshMiniCart);
                    });
                    this.actionRefreshMiniCart();
                };

                this.userInteractionEvents.forEach(eventType => {
                    window.addEventListener(eventType, refreshMiniCart, {
                        once: true,
                        passive: true
                    });
                });
            }

            reloadCustomerLoginPage() {
                const backendLoggedInState = this.options.isCustomerLoggedIn;

                const getCustomerDataFromStorage = () => {
                    try {
                        const cacheStorage = localStorage.getItem('mage-cache-storage');
                        const customerData = cacheStorage ? JSON.parse(cacheStorage).customer : null;
                        return customerData;
                    } catch (error) {
                        console.warn('BFCache: Failed to parse customer data from localStorage', error);
                        return null;
                    }
                };

                const customerData = getCustomerDataFromStorage();
                const frontendLoggedInState = Boolean(customerData?.firstname);

                if (frontendLoggedInState !== backendLoggedInState) {
                    window.location.reload();
                }
            }

            actionRefreshMiniCart() {
                window.dispatchEvent(new CustomEvent('reload-customer-section-data'));
            }

            actionAutoCloseMenu(autoCloseMenuMobile) {
                window.dispatchEvent(new Event('clear-messages'));

                const cartDrawer = document.querySelector("[x-data^='initCartDrawer']");
                requestAnimationFrame(() => {
                    if (cartDrawer && typeof Alpine !== 'undefined') {
                        const cartDrawerData = Alpine.$data(cartDrawer);
                        if (cartDrawerData?.open !== undefined) {
                            cartDrawerData.open = false;
                            document.body.style.overflow = '';
                        }
                    }
                });

                if (autoCloseMenuMobile) {
                    this.handleMenuClosure();
                }
            }

            handleMenuClosure() {
                const mobileMenu = document.querySelector("[x-data^='initMenuMobile']");
                if (mobileMenu && typeof Alpine !== 'undefined') {
                    const mobileMenuData = Alpine.$data(mobileMenu);
                    if (mobileMenuData?.open !== undefined) {
                        mobileMenuData.open = false;
                    }
                }

                const desktopMenu = document.querySelector("[x-data^='initMenuDesktop']");
                if (desktopMenu && typeof Alpine !== 'undefined') {
                    const desktopMenuData = Alpine.$data(desktopMenu);
                    if (desktopMenuData?.hoverPanelActiveId !== undefined) {
                        desktopMenuData.hoverPanelActiveId = 0;
                    }
                }
            }
        };

        // Always run init on pageshow (back/forward navigation + BFCache restore)
        const handlePageShow = () => {
            new BFCacheHandler().init();
        };

        window.addEventListener('pageshow', handlePageShow, { passive: true });
    })();
</script>
<?php $hyvaCsp->registerInlineScript() ?>
